package com.kaluna.signage{	import flash.events.Event;	import flash.events.EventDispatcher;	import flash.events.IOErrorEvent;	import flash.events.ProgressEvent;	import flash.events.SecurityErrorEvent;	import flash.net.URLLoader;	import flash.net.URLLoaderDataFormat;	import flash.net.URLRequest;	import flash.net.URLRequestMethod;	import flash.net.URLVariables;	import flash.net.navigateToURL;	import flash.system.LoaderContext;	import flash.system.Security;	import flash.system.System;
	public class XMLRestloading extends EventDispatcher  {		public static const LOAD_COMPLETE:String = "load_complete";		public static const LOAD_PROGRESS:String = "load_progress";		public static const LOAD_ERROR:String = "load_error";		public var xmlLoader:URLLoader;		public var newXML:XML;		public var nowLoad:Number;				//コンストラクタ		public function XMLRestloading(url:String, variables:Object = null, method:String = "GET", isUnicode:Boolean = true,security:Boolean = false) {			//URLLoader作成			xmlLoader = new URLLoader();			xmlLoader.dataFormat = URLLoaderDataFormat.TEXT;			xmlLoader.addEventListener(Event.COMPLETE, onXMLloaded);			xmlLoader.addEventListener(ProgressEvent.PROGRESS, onXMLload);			xmlLoader.addEventListener(IOErrorEvent.IO_ERROR,onError);			xmlLoader.addEventListener(SecurityErrorEvent.SECURITY_ERROR,onSecError);						if(security){				Security.allowDomain("*");				Security.loadPolicyFile("http://" + url.split("/")[2] + "/crossdomain.xml");			}			//URL			var urlReq:URLRequest = new URLRequest(url);			//引数			if(variables){				var urlVariables:URLVariables = new URLVariables();				for (var i:String in variables){					urlVariables[i] = variables[i];				}				urlReq.data = urlVariables;			}			if(method == "GET") urlReq.method = URLRequestMethod.GET;			else urlReq.method = URLRequestMethod.POST;						//Unicode以外ならばtrue			System.useCodePage = ! isUnicode;			//読み込み開始			xmlLoader.load(urlReq);			//navigateToURL(urlReq);		}		//読み込み完了		private function onXMLloaded(e:Event):void {			try {				//XMLオブジェクトに変換する				newXML = new XML(xmlLoader.data);				//カスタムイベントを配信する				dispatchEvent(new Event(LOAD_COMPLETE));				trace("XML完了");			} catch (err:TypeError) {				trace(err.message);			}			rmListener();		}		//読み込み開始		private function onXMLload(e:ProgressEvent):void {			//読み込みパーセント			nowLoad = Math.round((e.bytesLoaded/e.bytesTotal)*100);			//カスタムイベントを配信する			dispatchEvent(new Event(LOAD_PROGRESS));		}		private function onError(e:IOErrorEvent):void{			dispatchEvent(new Event(LOAD_ERROR));			rmListener();			trace("REST読み込みエラー");		}		private function onSecError(e:SecurityErrorEvent):void{			dispatchEvent(new Event(LOAD_ERROR));			rmListener();			trace("セキュリティエラー");		}		private function rmListener():void{			xmlLoader.removeEventListener(Event.COMPLETE, onXMLloaded);			xmlLoader.removeEventListener(ProgressEvent.PROGRESS, onXMLload);			xmlLoader.removeEventListener(IOErrorEvent.IO_ERROR,onError);			xmlLoader.removeEventListener(SecurityErrorEvent.SECURITY_ERROR,onSecError);		}		//XMLオブジェクトを返す（他のクラスからのアクセスに対応）		public function getXML():XML{			return newXML;		}	}}